<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketOn PRO - Editor de Rifas</title>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Variaveis da UI do Editor (Dark Theme) */
            --bg-color: #0c0c0e;
            --surface-color: #16161a;
            --border-color: #2c2c35;
            --text-primary: #ffffff;
            --text-secondary: #a0a0ab;
            --accent-color: #ff6b2b;
            --accent-hover: #e55a20;

            /* Variaveis Globais do Card Gerado (Podem mudar por JS) */
            --card-color: #005ce6; /* Azul padr√£o */
            --card-radius: 16px;
            --card-bg: #111116; /* Fundo do card, ex: dark */
            --card-text: #ffffff;
            --grid-cols: 10;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* TIPOGRAFIA BEBAS */
        .bebas {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        /* --- TOPBAR --- */
        .topbar {
            height: 60px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
        }

        .logo-area span.pro-badge {
            background-color: var(--accent-color);
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .topbar-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        /* --- MAIN LAYOUT --- */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 320px;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 15px 0;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }

        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Formularios Sidebar */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Toggles */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-color);
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Paleta de Cores */
        .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.active { border-color: white; }

        .custom-color-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .template-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            background: var(--bg-color);
            transition: 0.2s;
        }
        .template-card.active {
            border-color: var(--accent-color);
        }
        
        /* Tema representa√ß√µes na thubmnail */
        .t-dark { background: #111116; color: white; }
        .t-light { background: #fafaf7; color: black; }
        .t-neon { background: #050510; color: #00ffff; border: 1px solid #00ffff;}
        .t-bold { background: #ff4500; color: white; }
        .t-paper { background: #fdf5e6; color: #333; }

        /* --- PREVIEW AREA --- */
        .preview-area {
            flex: 1;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        .localhost-banner {
            position: absolute;
            top: 20px;
            background-color: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none;
        }

        /* --- O CARD EXPORT√ÅVEL --- */
        /* Esse card √© o que o html2canvas vai "Tirar foto" */
        #card-preview {
            width: 450px; /* Largura base simulando mobile */
            background-color: var(--card-bg);
            color: var(--card-text);
            border-radius: var(--card-radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Elementos Internos do Card */
        #c-header-img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .c-body {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .c-title-area {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #c-title {
            font-size: 32px;
            line-height: 1;
        }
        
        #c-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        #c-badge-org {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 2;
        }

        .c-stats-row {
            display: flex;
            gap: 12px;
        }

        .c-stat-box {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .c-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.6;
            font-weight: 700;
        }

        .c-stat-value {
            font-size: 16px;
            font-weight: 700;
        }

        .c-progress-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .c-progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
        }

        #c-progress-pct {
            color: var(--card-color);
        }

        .c-progress-bar-bg {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .c-progress-bar-fill {
            height: 100%;
            background-color: var(--card-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* Grade de Tickets Interna */
        .c-grid-wrapper {
             background: rgba(255,255,255,0.02);
             padding: 16px;
             border-radius: 12px;
             border: 1px solid rgba(255,255,255,0.05);
        }

        #c-grid-container {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols), 1fr);
            gap: 4px;
        }

        .c-ticket {
            background-color: #22c55e; /* Livre */
            color: white;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border-radius: 4px;
        }
        
        /* Modificadores de Status fixos para o demo */
        .c-ticket.status-reservado { background-color: #f97316; }
        .c-ticket.status-pago { background-color: #475569; }
        .c-ticket.status-destaque { background-color: var(--card-color); }

        .c-grid-legend {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .leg-item { display: flex; align-items: center; gap: 4px; }
        .leg-color { width: 10px; height: 10px; border-radius: 50%; }

        .c-footer {
            text-align: center;
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #c-cta {
            font-size: 24px;
            color: var(--card-color);
        }

        #c-watermark {
            font-size: 10px;
            opacity: 0.4;
            font-weight: 500;
        }

        /* TEMA NEON ESPECIFICO */
        #card-preview.theme-neon {
            border: 2px solid var(--card-color);
            box-shadow: 0 0 30px rgba(var(--card-color-rgb), 0.3);
        }
        #card-preview.theme-neon #c-title {
            text-shadow: 0 0 10px var(--card-color);
        }

        /* Tema Light/Paper Inversoes */
        #card-preview.theme-light, #card-preview.theme-paper {
            --card-bg: #ffffff;
            --card-text: #111;
        }
        #card-preview.theme-paper {
            --card-bg: #fdf5e6;
        }
        #card-preview.theme-light .c-stat-box, #card-preview.theme-paper .c-stat-box {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.05);
        }
        #card-preview.theme-light .c-progress-bar-bg, #card-preview.theme-paper .c-progress-bar-bg {
            background: rgba(0,0,0,0.1);
        }
        #card-preview.theme-light .c-grid-wrapper, #card-preview.theme-paper .c-grid-wrapper {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.05);
        }

        /* Utility Hide */
        .hidden { display: none !important; }

        /* Loader */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }
        #loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Responsivo Mobile */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .preview-area {
                height: 60vh;
                padding: 20px;
            }
            #card-preview {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }

    </style>
</head>
<body>

    <!-- TOPBAR -->
    <header class="topbar">
        <div class="logo-area">
            TicketOn <span class="pro-badge">PRO</span>
        </div>
        <div class="topbar-actions">
            <button class="btn" onclick="resetEditor()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                Reset
            </button>
            <button class="btn btn-primary" onclick="exportImage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Baixar PNG
            </button>
        </div>
    </header>

    <div class="main-container">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('design')">Design</button>
                <button class="tab-btn" onclick="switchTab('content')">Conte√∫do</button>
                <button class="tab-btn" onclick="switchTab('tickets')">Tickets</button>
            </div>

            <!-- TAB DESIGN -->
            <div id="tab-design" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Template</label>
                    <div class="template-grid">
                        <div class="template-card t-dark active" onclick="setTheme('dark')">Dark</div>
                        <div class="template-card t-light" onclick="setTheme('light')">Light</div>
                        <div class="template-card t-neon" onclick="setTheme('neon')">Neon</div>
                        <div class="template-card t-bold" onclick="setTheme('bold')">Bold</div>
                        <div class="template-card t-paper" onclick="setTheme('paper')">Paper</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Cor Principal</label>
                    <div class="color-grid" id="color-grid">
                        <!-- Colors geradas via JS -->
                    </div>
                    <div class="custom-color-wrapper">
                        Personalizada: <input type="color" id="ctrl-color-picker" value="#005ce6" oninput="setCardColor(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Elementos Vis√≠veis</label>
                    
                    <div class="toggle-row">
                        <span>Foto do pr√™mio</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-foto" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span>Barra de progresso</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-progresso" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span>Grid de tickets</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-grid" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span>Legenda</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-legenda" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span>Badge organizador</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-badge" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-row">
                        <span>Marca d'√°gua</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-watermark" checked onchange="updateVisibility()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Arredondamento do Card</label>
                    <input type="range" id="ctrl-radius" min="0" max="32" value="16" class="form-input" style="padding:0; height:4px; max-width: 100%;" oninput="document.documentElement.style.setProperty('--card-radius', this.value + 'px')">
                </div>
            </div>

            <!-- TAB CONTENT -->
            <div id="tab-content" class="tab-content">
                <div class="form-group">
                    <label class="form-label">Foto do Pr√™mio (URL ou Upload)</label>
                    <input type="text" id="ctrl-img-url" class="form-input" placeholder="https://..." oninput="updateContent()">
                    <input type="file" id="ctrl-img-file" class="form-input" style="margin-top: 8px;" accept="image/*" onchange="handleImageUpload(this)">
                </div>

                <div class="form-group">
                    <label class="form-label">Nome do Pr√™mio</label>
                    <input type="text" id="ctrl-title" class="form-input" value="PC GAMER RTX 4090" oninput="updateContent()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Subt√≠tulo</label>
                    <input type="text" id="ctrl-subtitle" class="form-input" value="Rifa oficial - participe e concorra!" oninput="updateContent()">
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Valor (Cota)</label>
                        <input type="text" id="ctrl-price" class="form-input" value="R$ 1,00" oninput="updateContent()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Data Sorteio</label>
                        <input type="text" id="ctrl-date" class="form-input" value="14/01/2025" oninput="updateContent()">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Total Tickets</label>
                        <input type="number" id="ctrl-total" class="form-input" value="100" oninput="updateProgressAndGrid()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Vendidos</label>
                        <input type="number" id="ctrl-sold" class="form-input" value="12" oninput="updateProgressAndGrid()">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Organizador (@)</label>
                    <input type="text" id="ctrl-org" class="form-input" value="@seuperfil" oninput="updateContent()">
                </div>

                <div class="form-group">
                    <label class="form-label">Texto CTA</label>
                    <input type="text" id="ctrl-cta" class="form-input" value="PARTICIPE AGORA MESMO" oninput="updateContent()">
                </div>
            </div>

            <!-- TAB TICKETS -->
            <div id="tab-tickets" class="tab-content">
                <div class="form-group">
                    <label class="form-label">Op√ß√µes da Grade</label>
                    <div class="toggle-row">
                        <span>Mostrar n√∫meros nos tickets</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tgl-numbers" checked onchange="renderGrid()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Colunas da Grade (5 a 15)</label>
                    <input type="range" id="ctrl-cols" min="5" max="15" value="10" class="form-input" style="padding:0; height:4px; max-width: 100%;" oninput="document.documentElement.style.setProperty('--grid-cols', this.value); renderGrid();">
                </div>

                <div class="form-group">
                    <label class="form-label">Tickets em Destaque (Separados por v√≠rgula)</label>
                    <p style="font-size:11px; color:var(--text-secondary); margin-bottom: 8px;">Ex: 7, 13, 42 (Pintar√° com a cor principal)</p>
                    <input type="text" id="ctrl-highlights" class="form-input" value="4, 5, 12, 56" oninput="renderGrid()">
                </div>
            </div>
        </aside>

        <!-- PREVIEW AREA -->
        <main class="preview-area" id="preview-area">
            <div class="localhost-banner">‚ö° Preview em tempo real - prot√≥tipo localhost</div>
            
            <div id="card-preview" class="theme-dark">
                
                <div id="c-badge-org">@seuperfil</div>
                
                <img id="c-header-img" src="" style="display: none;" />
                <div id="c-header-emoji" style="width: 100%; height: 240px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 80px;">üèÜ</div>

                <div class="c-body">
                    <div class="c-title-area">
                        <div id="c-title" class="bebas">PC GAMER RTX 4090</div>
                        <div id="c-subtitle">Rifa oficial - participe e concorra!</div>
                    </div>

                    <div class="c-stats-row">
                        <div class="c-stat-box">
                            <span class="c-stat-label">Cota</span>
                            <span class="c-stat-value" id="c-price">R$ 1,00</span>
                        </div>
                        <div class="c-stat-box">
                            <span class="c-stat-label">Sorteio</span>
                            <span class="c-stat-value" id="c-date">14/01/2025</span>
                        </div>
                        <div class="c-stat-box">
                            <span class="c-stat-label">Tickets</span>
                            <span class="c-stat-value" id="c-total">100</span>
                        </div>
                    </div>

                    <div id="c-progress-wrapper" class="c-progress-area">
                        <div class="c-progress-header">
                            <span>Progresso</span>
                            <span id="c-progress-pct">12%</span>
                        </div>
                        <div class="c-progress-bar-bg">
                            <div class="c-progress-bar-fill" id="c-progress-fill" style="width: 12%"></div>
                        </div>
                    </div>

                    <div id="c-grid-section" class="c-grid-wrapper">
                        
                        <div id="c-legend" class="c-grid-legend">
                            <div class="leg-item"><div class="leg-color" style="background:#22c55e"></div> Livre</div>
                            <div class="leg-item"><div class="leg-color" style="background:#f97316"></div> Reservado</div>
                            <div class="leg-item"><div class="leg-color" style="background:#475569"></div> Pago</div>
                        </div>

                        <div id="c-grid-container">
                            <!-- Gerado via JS -->
                        </div>
                    </div>

                    <div class="c-footer">
                        <div id="c-cta" class="bebas">PARTICIPE AGORA MESMO</div>
                        <div style="font-size: 11px; opacity: 0.6;">COMPRA SEGURA ‚Ä¢ PAGAMENTO VIA PIX</div>
                        <div id="c-watermark" style="margin-top: 8px;">‚ú¶ ticketon.com.br</div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        Gerando imagem em alta resolu√ß√£o...
    </div>

    <!-- SCRIPTS -->
    <script>
        // State
        const defaultColors = ['#005ce6', '#22c55e', '#ef4444', '#eab308', '#f97316', '#a855f7', '#ec4899', '#06b6d4', '#14b8a6'];
        let currentTheme = 'dark';

        // Init
        window.onload = () => {
            initColorGrid();
            setCardColor('#005ce6'); // Default Blue
            updateContent();
            updateProgressAndGrid();
            updateVisibility();
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function initColorGrid() {
            const grid = document.getElementById('color-grid');
            defaultColors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-option';
                div.style.backgroundColor = color;
                div.onclick = () => {
                    document.getElementById('ctrl-color-picker').value = color;
                    setCardColor(color);
                };
                grid.appendChild(div);
            });
        }

        function setCardColor(hex) {
            document.documentElement.style.setProperty('--card-color', hex);
            
            // Calc RGB for Glow (Neon theme)
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){
                    c= [c[0], c[0], c[1], c[1], c[2], c[2]];
                }
                c= '0x'+c.join('');
                document.documentElement.style.setProperty('--card-color-rgb', [(c>>16)&255, (c>>8)&255, c&255].join(','));
            }
        }

        function setTheme(theme) {
            // Update UI
            document.querySelectorAll('.template-card').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update Card
            const card = document.getElementById('card-preview');
            card.className = ''; // reset
            card.classList.add('theme-' + theme);
            currentTheme = theme;
        }

        function updateContent() {
            // Texts
            document.getElementById('c-title').textContent = document.getElementById('ctrl-title').value.toUpperCase() || 'T√çTULO';
            document.getElementById('c-subtitle').textContent = document.getElementById('ctrl-subtitle').value;
            document.getElementById('c-price').textContent = document.getElementById('ctrl-price').value;
            document.getElementById('c-date').textContent = document.getElementById('ctrl-date').value;
            document.getElementById('c-badge-org').textContent = document.getElementById('ctrl-org').value;
            document.getElementById('c-cta').textContent = document.getElementById('ctrl-cta').value.toUpperCase();

            // Image URL
            const mapUrl = document.getElementById('ctrl-img-url').value;
            const imgEl = document.getElementById('c-header-img');
            const emojiEl = document.getElementById('c-header-emoji');
            
            if (mapUrl && mapUrl.length > 5 && document.getElementById('tgl-foto').checked) {
                imgEl.src = mapUrl;
                imgEl.style.display = 'block';
                emojiEl.style.display = 'none';
            } else if (document.getElementById('tgl-foto').checked) {
                imgEl.style.display = 'none';
                emojiEl.style.display = 'flex';
            }
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('ctrl-img-url').value = ''; // clear url input
                    const imgEl = document.getElementById('c-header-img');
                    imgEl.src = e.target.result;
                    imgEl.style.display = 'block';
                    document.getElementById('c-header-emoji').style.display = 'none';
                    // force visibility on
                    document.getElementById('tgl-foto').checked = true;
                    updateVisibility();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProgressAndGrid() {
            const total = parseInt(document.getElementById('ctrl-total').value) || 100;
            const sold = parseInt(document.getElementById('ctrl-sold').value) || 0;
            
            document.getElementById('c-total').textContent = total;
            
            const pct = total > 0 ? Math.min(100, Math.round((sold / total) * 100)) : 0;
            document.getElementById('c-progress-pct').textContent = pct + '%';
            document.getElementById('c-progress-fill').style.width = pct + '%';

            renderGrid(total);
        }

        function renderGrid(overrideTotal) {
            const total = overrideTotal || parseInt(document.getElementById('ctrl-total').value) || 100;
            const container = document.getElementById('c-grid-container');
            const showNumbers = document.getElementById('tgl-numbers').checked;
            const highlightsRaw = document.getElementById('ctrl-highlights').value;
            
            // Parse highlights
            const highlights = highlightsRaw.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));

            container.innerHTML = '';
            
            // Max 100 on preview to avoid DOM overload, just visual
            const limit = Math.min(total, 100); 

            for(let i = 1; i <= limit; i++) {
                const div = document.createElement('div');
                div.className = 'c-ticket';
                
                if (showNumbers) div.textContent = i;

                // Fake statuses logic for demonstration
                if (highlights.includes(i)) {
                    div.classList.add('status-destaque');
                } else if (i % 7 === 0) {
                    div.classList.add('status-reservado');
                } else if (i % 3 === 0) {
                    div.classList.add('status-pago');
                }
                
                container.appendChild(div);
            }
            
            if (total > 100) {
                const plus = document.createElement('div');
                plus.className = 'c-ticket';
                plus.style.background = 'transparent';
                plus.style.color = 'var(--text-secondary)';
                plus.textContent = '+' + (total-100);
                container.appendChild(plus);
            }
        }

        function updateVisibility() {
            const get = id => document.getElementById(id);
            const tg = id => document.getElementById('tgl-' + id).checked;

            // Foto
            const imgEl = get('c-header-img');
            const emojiEl = get('c-header-emoji');
            
            if(!tg('foto')) {
                imgEl.style.display = 'none';
                emojiEl.style.display = 'none';
            } else {
                if(imgEl.src && imgEl.src.length > 10 && imgEl.src.indexOf('undefined')===-1) {
                    imgEl.style.display = 'block';
                } else {
                    emojiEl.style.display = 'flex';
                }
            }

            // Others
            get('c-progress-wrapper').classList.toggle('hidden', !tg('progresso'));
            get('c-grid-section').classList.toggle('hidden', !tg('grid'));
            get('c-legend').classList.toggle('hidden', !tg('legenda'));
            get('c-badge-org').classList.toggle('hidden', !tg('badge'));
            get('c-watermark').classList.toggle('hidden', !tg('watermark'));
        }

        function resetEditor() {
            if(confirm("Deseja resetar todas as configura√ß√µes para o padr√£o?")) {
                location.reload();
            }
        }

        async function exportImage() {
            const loader = document.getElementById('loading-overlay');
            const card = document.getElementById('card-preview');
            
            loader.classList.add('show');
            
            // Give browser time to paint loader before freezing thread
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(card, {
                        scale: 2.5, // High resolution
                        useCORS: true,
                        backgroundColor: null,
                        logging: false
                    });

                    const link = document.createElement('a');
                    link.download = 'campanha-pro-' + Date.now() + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                } catch (e) {
                    console.error("Erro ao gerar imagem:", e);
                    alert("Houve um problema ao exportar a imagem. Verifique se a foto utilizada permtite acesso CORS.");
                } finally {
                    loader.classList.remove('show');
                }
            }, 100);
        }

    </script>
</body>
</html>
